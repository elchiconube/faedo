---
// MapaFaedoLeaflet.astro
// Datos del track GPX real de Wikiloc - Ruta circular El Faedo
import 'leaflet/dist/leaflet.css';
---

<div id="mapa-leaflet-container" class="mapa-faedo-leaflet">
  <div
    id="mapa-leaflet"
    style="height: 400px; width: 100%; border-radius: 8px;"
  >
  </div>
</div>

<style>
  .mapa-faedo-leaflet {
    margin: 2rem 0;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    overflow: hidden;
  }

  .leaflet-popup-content {
    font-family: Arial, sans-serif;
    max-width: 250px;
  }

  .leaflet-popup-content h4 {
    margin: 0 0 8px 0;
    color: #2d5016;
    font-size: 16px;
  }

  .leaflet-popup-content p {
    margin: 4px 0;
    font-size: 13px;
    color: #666;
  }

  .leaflet-popup-content .datos {
    background: #f0f9ff;
    padding: 8px;
    border-radius: 4px;
    margin-top: 8px;
    border-left: 3px solid #3b82f6;
  }
</style>

<script>
  import L from 'leaflet';
  document.addEventListener("DOMContentLoaded", function () {
    // Coordenadas reales del centro de la ruta (calculadas del GPX)
    const centroRuta = [42.884037, -5.622944];

    // Track completo de la ruta real del GPX (108 puntos)
    const rutaCompleta = [
      [42.884014, -5.636232],
      [42.883918, -5.63618],
      [42.883903, -5.636031],
      [42.883934, -5.635371],
      [42.884265, -5.634478],
      [42.884477, -5.63351],
      [42.884234, -5.632325],
      [42.884335, -5.631695],
      [42.88408, -5.630403],
      [42.884095, -5.629276],
      [42.883984, -5.628798],
      [42.883935, -5.627561],
      [42.884073, -5.626611],
      [42.884124, -5.624899],
      [42.884278, -5.624281],
      [42.884354, -5.623375],
      [42.884186, -5.622325],
      [42.883855, -5.621655],
      [42.883875, -5.620938],
      [42.883702, -5.620513],
      [42.883713, -5.620235],
      [42.883593, -5.620117],
      [42.883592, -5.619832],
      [42.883444, -5.619371],
      [42.883657, -5.617404],
      [42.883369, -5.616743],
      [42.883452, -5.616507],
      [42.883566, -5.616386],
      [42.883666, -5.616388],
      [42.884122, -5.616963],
      [42.884203, -5.617449],
      [42.884456, -5.617499],
      [42.884518, -5.617103],
      [42.884909, -5.616825],
      [42.885017, -5.616487],
      [42.884808, -5.615313],
      [42.884798, -5.614744],
      [42.885008, -5.614397],
      [42.885043, -5.613606],
      [42.885193, -5.612719],
      [42.885435, -5.612005],
      [42.885368, -5.611666],
      [42.885577, -5.611448],
      [42.885835, -5.611343],
      [42.885955, -5.610798],
      [42.886161, -5.610424],
      [42.886245, -5.610512],
      [42.886302, -5.610408],
      [42.886352, -5.610024],
      [42.886618, -5.609592],
      [42.886585, -5.609523],
      [42.886224, -5.610098],
      [42.886223, -5.610368],
      [42.885857, -5.610851],
      [42.88577, -5.611379],
      [42.885477, -5.611447],
      [42.885341, -5.611655],
      [42.885319, -5.611799],
      [42.885419, -5.612049],
      [42.885288, -5.612349],
      [42.885051, -5.614536],
      [42.885181, -5.615889],
      [42.884923, -5.616763],
      [42.88479, -5.616975],
      [42.884648, -5.616997],
      [42.884439, -5.617175],
      [42.884408, -5.617522],
      [42.884188, -5.617396],
      [42.884094, -5.616783],
      [42.88346, -5.615088],
      [42.884007, -5.61545],
      [42.884319, -5.615827],
      [42.884328, -5.616114],
      [42.884179, -5.615699],
      [42.883834, -5.615241],
      [42.883479, -5.614975],
      [42.882873, -5.6149],
      [42.882064, -5.614433],
      [42.881721, -5.614557],
      [42.881455, -5.614879],
      [42.881475, -5.615027],
      [42.882043, -5.615792],
      [42.882633, -5.616847],
      [42.882747, -5.617321],
      [42.882789, -5.618008],
      [42.882661, -5.619145],
      [42.882813, -5.620193],
      [42.882841, -5.621667],
      [42.882618, -5.624038],
      [42.882722, -5.624664],
      [42.882736, -5.62542],
      [42.882966, -5.626309],
      [42.882945, -5.627561],
      [42.883031, -5.628627],
      [42.883129, -5.628936],
      [42.883304, -5.629132],
      [42.883358, -5.629407],
      [42.883296, -5.630859],
      [42.883344, -5.631831],
      [42.883445, -5.632318],
      [42.883414, -5.633038],
      [42.883496, -5.634003],
      [42.883345, -5.635092],
      [42.883354, -5.635536],
      [42.883442, -5.635698],
      [42.883877, -5.635887],
      [42.883831, -5.636078],
      [42.883984, -5.636365]
    ];

    // Crear el mapa centrado en la ruta real
    const map = L.map("mapa-leaflet").setView(centroRuta, 14);

    // Capa base: PNOA M√°xima Actualidad (ortofoto con datos topogr√°ficos)
    L.tileLayer("https://tms-pnoa-ma.idee.es/1.0.0/pnoa-ma/{z}/{x}/{-y}.jpeg", {
      attribution:
        '¬© <a href="https://www.ign.es/">IGN</a> - <a href="https://www.scne.es/">PNOA CC-BY 4.0 scne.es</a>',
      maxZoom: 20,
      minZoom: 1,
      tms: true,
    }).addTo(map);

    // Capa superpuesta: IGN Base Orto (nombres de localidades y etiquetas)
    L.tileLayer(
      "https://tms-ign-base.idee.es/1.0.0/IGNBaseOrto/{z}/{x}/{-y}.png",
      {
        attribution:
          '¬© <a href="https://www.ign.es/">IGN</a> - <a href="https://www.scne.es/">IGN Base CC-BY 4.0 scne.es</a>',
        maxZoom: 19,
        minZoom: 1,
        tms: true,
        opacity: 0.7, // Semi-transparente para que se vea la ortofoto de abajo
      }
    ).addTo(map);

    // Icono personalizado para el Faedo
    const iconoFaedo = L.divIcon({
      html: `
        <div style="
          background: #4ade80;
          border: 2px solid #166534;
          border-radius: 50%;
          width: 32px;
          height: 32px;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        ">
          üå≥
        </div>
      `,
      className: "custom-div-icon",
      iconSize: [32, 32],
      iconAnchor: [16, 16],
      popupAnchor: [0, -16],
    });

    // Marcador en el punto de inicio real (Iglesia de San Miguel Arc√°ngel - Ci√±era)
    const marcadorInicio = L.marker([42.884014, -5.636232], { icon: iconoFaedo })
      .addTo(map)
      .bindPopup(
        `
        <div>
          <h4>üöó Inicio: Iglesia San Miguel Arc√°ngel</h4>
          <p>Ci√±era de Gord√≥n - Punto de partida de la ruta circular.</p>
          <div class="datos">
            <p><strong>üìç Altitud:</strong> 1.057m</p>
            <p><strong>ü•æ Distancia total:</strong> 6,01 km (circular)</p>
            <p><strong>‚≠ê Dificultad:</strong> F√°cil-Moderada</p>
            <p><strong>‚è±Ô∏è Tiempo:</strong> 2-2,5 horas</p>
            <p><strong>üéØ Desnivel:</strong> +108m (1.051-1.159m)</p>
            <p><strong>üçÇ Mejor √©poca:</strong> Oto√±o (colores)</p>
          </div>
        </div>
      `,
        { maxWidth: 300 }
      );

    // Puntos de inter√©s basados en el track real del GPX
    const puntosInteres = [
      {
        coords: [42.883566, -5.616386],
        titulo: "üå≤ Entrada al Faedo",
        descripcion:
          "Primer contacto con el bosque de hayas. Altitud: 1.114m. Aqu√≠ empieza la magia del faedo.",
      },
      {
        coords: [42.884179, -5.615699],
        titulo: "üèîÔ∏è Punto m√°s alto de la ruta",
        descripcion:
          "M√°xima altitud: 1.159m. Vistas espectaculares del valle y los Picos de Europa.",
      },
      {
        coords: [42.886618, -5.609592],
        titulo: "üå≥ Coraz√≥n del Faedo",
        descripcion:
          "Centro del bosque de hayas centenario. Las hayas m√°s impresionantes y Marmitas de Gigante est√°n cerca.",
      },
      {
        coords: [42.885857, -5.610851],
        titulo: "üëÅÔ∏è Mirador del Beso",
        descripcion:
          "Uno de los miradores m√°s rom√°nticos de la ruta. Vista panor√°mica hacia el valle.",
      },
      {
        coords: [42.882043, -5.615792],
        titulo: "üíß Pozo Ibarra",
        descripcion:
          "Zona de descanso junto al agua. Altitud: 1.150m. Perfecto para una pausa en la ruta.",
      },
    ];

    // A√±adir marcadores de puntos de inter√©s
    puntosInteres.forEach((punto, index) => {
      const iconoPunto = L.divIcon({
        html: `
          <div style="
            background: #3b82f6;
            border: 2px solid #1e40af;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
          ">
            ${index + 1}
          </div>
        `,
        className: "custom-div-icon",
        iconSize: [24, 24],
        iconAnchor: [12, 12],
        popupAnchor: [0, -12],
      });

      L.marker(punto.coords, { icon: iconoPunto }).addTo(map).bindPopup(`
          <div>
            <h4>${punto.titulo}</h4>
            <p>${punto.descripcion}</p>
          </div>
        `);
    });

    // Dibujar la ruta real del GPX optimizada para vista sat√©lite
    const polylineRuta = L.polyline(rutaCompleta, {
      color: "#ffff00",
      weight: 4,
      opacity: 0.9,
      dashArray: "10, 5",
      lineCap: "round",
      lineJoin: "round",
    }).addTo(map);

    // A√±adir una l√≠nea de sombra negra para mejor contraste en sat√©lite
    const sombraRuta = L.polyline(rutaCompleta, {
      color: "#000000",
      weight: 6,
      opacity: 0.7,
      lineCap: "round",
      lineJoin: "round",
    }).addTo(map);

    // Mover la sombra detr√°s de la ruta principal
    sombraRuta.bringToBack();

    // Ajustar vista para mostrar toda la ruta
    map.fitBounds(polylineRuta.getBounds(), { padding: [20, 20] });

    // A√±adir leyenda actualizada con datos reales
    const leyenda = L.control({ position: "bottomright" });
    leyenda.onAdd = function (map) {
      const div = L.DomUtil.create("div", "info legend");
      div.innerHTML = `
        <div style="
          background: rgba(255,255,255,0.95);
          padding: 12px;
          border-radius: 8px;
          box-shadow: 0 2px 6px rgba(0,0,0,0.3);
          font-size: 12px;
          line-height: 20px;
          border-left: 4px solid #ffff00;
        ">
          <div style="font-weight: bold; margin-bottom: 6px; color: #e67e00;">Ruta circular El Faedo de Ci√±era</div>
          <div><span style="color: #ffff00; font-weight: bold; text-shadow: 1px 1px 1px #000;">‚îÅ‚îÅ‚îÅ</span> Track GPS real (6,01 km)</div>
          <div>üõ∞Ô∏è PNOA + IGN Base superpuestos</div>
          <div>üè∑Ô∏è Ortofoto con nombres de localidades</div>
          <div>üöó Inicio: Iglesia San Miguel Arc√°ngel</div>
          <div>üå≥ Faedo de Ci√±era (hayas centenarias)</div>
          <div>‚õ∞Ô∏è Desnivel: +108m (1.051-1.159m)</div>
          <div>üéØ Puntos: Marmitas ‚Ä¢ Mirador del Beso ‚Ä¢ Pozo Ibarra</div>
          <div>‚ë† ‚ë° ‚ë¢ ‚ë£ ‚ë§ Puntos destacados de la ruta</div>
        </div>
      `;
      return div;
    };
    leyenda.addTo(map);

    // A√±adir escala
    L.control
      .scale({ position: "bottomleft", metric: true, imperial: false })
      .addTo(map);
  });
</script>