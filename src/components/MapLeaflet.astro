---
// MapaFaedoLeaflet.astro
// Datos del track GPX correcto de Wikiloc
---

<div id="mapa-leaflet-container" class="mapa-faedo-leaflet">
  <div id="mapa-leaflet" style="height: 400px; width: 100%; border-radius: 8px;"></div>
</div>

<style>
  .mapa-faedo-leaflet {
    margin: 2rem 0;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    overflow: hidden;
  }
  
  .leaflet-popup-content {
    font-family: Arial, sans-serif;
    max-width: 250px;
  }
  
  .leaflet-popup-content h4 {
    margin: 0 0 8px 0;
    color: #2d5016;
    font-size: 16px;
  }
  
  .leaflet-popup-content p {
    margin: 4px 0;
    font-size: 13px;
    color: #666;
  }
  
  .leaflet-popup-content .datos {
    background: #f0f9ff;
    padding: 8px;
    border-radius: 4px;
    margin-top: 8px;
    border-left: 3px solid #3b82f6;
  }
</style>

<!-- CSS de Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
      crossorigin=""/>

<!-- JavaScript de Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
        crossorigin=""></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Coordenadas reales del centro de la ruta (del GPX correcto)
    const centroRuta = [42.884960, -5.622914];
    
    // Track completo de la ruta real (cada ~10 puntos para optimizar rendimiento)
    const rutaCompleta = [
      [42.883939, -5.6362], [42.883799, -5.636306], [42.883918, -5.636131],
      [42.883864, -5.636029], [42.883852, -5.635881], [42.883869, -5.635754],
      [42.883862, -5.635624], [42.883895, -5.635486], [42.883937, -5.635291],
      [42.883982, -5.635236], [42.883977, -5.635099], [42.883989, -5.634945],
      [42.884009, -5.634817], [42.884068, -5.634719], [42.884111, -5.634604],
      [42.884143, -5.634478], [42.884208, -5.634374], [42.884233, -5.634252],
      [42.884267, -5.634124], [42.884299, -5.633984], [42.884334, -5.63386],
      [42.884364, -5.633727], [42.884411, -5.6336], [42.884376, -5.633457],
      [42.884349, -5.633325], [42.88431, -5.633127], [42.884267, -5.633003],
      [42.88424, -5.632866], [42.884212, -5.632734], [42.884178, -5.632612],
      [42.884175, -5.632481], [42.884225, -5.632353], [42.884232, -5.632207],
      [42.884264, -5.632067], [42.884285, -5.631852], [42.884288, -5.631717],
      [42.884259, -5.631516], [42.884237, -5.631293], [42.884205, -5.631106],
      [42.884173, -5.630978], [42.884143, -5.630846], [42.884094, -5.630719],
      [42.884059, -5.630536], [42.884037, -5.63039], [42.884025, -5.630257],
      [42.884045, -5.630129], [42.884043, -5.629989], [42.884031, -5.629784],
      [42.884043, -5.629645], [42.884025, -5.629374], [42.884017, -5.629221],
      [42.883992, -5.629013], [42.883968, -5.628873], [42.883922, -5.62868],
      [42.883894, -5.628473], [42.883899, -5.628336], [42.883889, -5.628126],
      [42.883871, -5.627975], [42.883889, -5.627773], [42.88391, -5.627555],
      [42.883905, -5.627343], [42.883917, -5.627145], [42.883944, -5.627017],
      [42.883977, -5.626892], [42.884006, -5.626687], [42.884031, -5.626562],
      [42.884054, -5.626365], [42.884064, -5.626173], [42.884052, -5.625964],
      [42.884033, -5.625834], [42.884041, -5.625633], [42.884063, -5.625421],
      [42.884081, -5.625284], [42.884086, -5.625154], [42.884095, -5.624946],
      [42.884123, -5.624673], [42.884178, -5.624459], [42.884235, -5.624259],
      [42.884267, -5.624049], [42.884276, -5.623854], [42.884286, -5.623569],
      [42.884281, -5.623365], [42.884273, -5.623171], [42.884215, -5.622973],
      [42.884174, -5.622765], [42.884124, -5.622559], [42.884066, -5.622301],
      [42.883994, -5.622111], [42.883874, -5.621893], [42.883806, -5.621799],
      [42.883797, -5.621674], [42.883778, -5.621402], [42.883794, -5.621042],
      [42.883724, -5.620788], [42.883681, -5.620673], [42.883659, -5.620398],
      [42.883637, -5.620273], [42.883587, -5.620159], [42.883563, -5.619967],
      [42.883508, -5.619832], [42.883475, -5.619586], [42.883432, -5.619331],
      [42.883469, -5.619177], [42.883466, -5.618967], [42.883438, -5.618851],
      [42.883475, -5.618722], [42.883472, -5.618578], [42.883495, -5.618098],
      [42.883516, -5.617892], [42.883538, -5.617678], [42.883576, -5.617553],
      [42.883576, -5.617354], [42.883511, -5.617247], [42.883441, -5.617075],
      [42.883393, -5.616965], [42.883347, -5.616855], [42.883325, -5.616641],
      [42.883385, -5.616531], [42.883495, -5.616391], [42.883585, -5.616349],
      [42.883683, -5.616398], [42.883765, -5.616488], [42.883839, -5.61656],
      [42.883955, -5.616686], [42.884028, -5.616786], [42.884098, -5.616891],
      [42.884147, -5.617073], [42.884187, -5.617270], [42.884253, -5.61743],
      [42.884357, -5.617455], [42.884420, -5.617375], [42.884452, -5.61726],
      [42.884485, -5.616992], [42.884592, -5.616955], [42.884729, -5.616898],
      [42.884806, -5.616815], [42.884870, -5.616785], [42.884918, -5.616604],
      [42.884959, -5.616382], [42.884973, -5.616235], [42.884883, -5.616084],
      [42.884813, -5.61583], [42.884833, -5.61574], [42.884805, -5.615568],
      [42.884734, -5.615391], [42.884732, -5.615273], [42.884753, -5.615123],
      [42.884774, -5.61498], [42.884769, -5.614897], [42.884758, -5.614699],
      [42.884823, -5.614624], [42.884911, -5.61456], [42.884949, -5.614495],
      [42.884951, -5.614327], [42.884949, -5.614123], [42.884969, -5.613923],
      [42.885004, -5.613816], [42.885019, -5.61362], [42.885001, -5.613349],
      [42.885031, -5.613233], [42.885047, -5.613008], [42.885085, -5.612811],
      [42.885155, -5.612632], [42.885178, -5.612485], [42.885288, -5.61245],
      [42.885258, -5.612247], [42.885323, -5.612127], [42.885381, -5.612002],
      [42.885318, -5.611909], [42.885297, -5.611727], [42.88536, -5.61155],
      [42.885399, -5.61149], [42.885517, -5.611411], [42.885587, -5.611307],
      [42.885764, -5.611306], [42.885807, -5.611072], [42.885877, -5.610854],
      [42.885942, -5.610751], [42.885987, -5.610578], [42.886044, -5.610478],
      [42.886137, -5.610405], [42.886197, -5.610395], [42.886278, -5.610398],
      [42.886318, -5.610285], [42.88635, -5.610187], [42.886338, -5.610057],
      [42.886303, -5.6099], [42.88633, -5.609792], [42.886438, -5.609804],
      [42.886519, -5.609734], [42.886459, -5.60965], [42.886429, -5.609557],
      [42.886595, -5.609549], [42.88647, -5.609665], [42.886440, -5.609717],
      [42.886322, -5.609802], [42.886309, -5.609943], [42.886322, -5.610080],
      [42.886279, -5.610195], [42.886243, -5.610365], [42.886264, -5.610507],
      [42.886222, -5.610463], [42.886155, -5.610416], [42.886073, -5.610574],
      [42.886058, -5.610745], [42.885996, -5.610922], [42.885881, -5.611035],
      [42.885808, -5.611127], [42.885828, -5.611274], [42.885683, -5.611418],
      [42.885575, -5.611463], [42.885400, -5.611617], [42.885360, -5.611607],
      [42.885388, -5.611822], [42.885399, -5.612019], [42.885336, -5.612355],
      [42.885268, -5.612583], [42.885275, -5.612718], [42.885243, -5.61291],
      [42.885240, -5.613047], [42.885250, -5.613312], [42.885232, -5.613504],
      [42.885197, -5.613768], [42.885135, -5.613952], [42.885111, -5.614155],
      [42.885093, -5.614360], [42.885079, -5.614575], [42.885045, -5.614837],
      [42.885052, -5.615038], [42.885079, -5.615255], [42.885104, -5.615462],
      [42.885142, -5.61565], [42.885169, -5.615782], [42.885143, -5.615974],
      [42.885089, -5.616234], [42.885047, -5.616446], [42.884982, -5.616634],
      [42.884905, -5.616798], [42.884833, -5.616902], [42.884735, -5.616972],
      [42.884610, -5.61705], [42.884513, -5.617093], [42.884483, -5.617191],
      [42.884486, -5.617335], [42.884443, -5.617463], [42.884348, -5.61747],
      [42.884209, -5.61742], [42.884157, -5.617311], [42.884144, -5.617114],
      [42.884079, -5.616944], [42.884007, -5.616836], [42.883950, -5.616718],
      [42.883880, -5.616611], [42.883806, -5.616525], [42.883678, -5.616415],
      [42.883538, -5.616415], [42.883456, -5.6165], [42.883386, -5.616597],
      [42.883356, -5.616726], [42.883393, -5.616849], [42.883452, -5.616949],
      [42.883495, -5.617059], [42.883537, -5.617172], [42.883604, -5.617275],
      [42.883609, -5.617413], [42.883571, -5.617538], [42.883549, -5.617668],
      [42.883541, -5.6178], [42.883527, -5.617867], [42.883527, -5.618066],
      [42.883534, -5.618195], [42.883530, -5.618392], [42.883526, -5.618537],
      [42.883484, -5.618788], [42.883493, -5.61892], [42.883457, -5.619114],
      [42.883469, -5.619244], [42.883449, -5.619368], [42.883456, -5.619503],
      [42.883486, -5.61969], [42.883519, -5.619815], [42.883543, -5.61994],
      [42.883579, -5.620137], [42.883643, -5.620275], [42.883663, -5.620402],
      [42.883706, -5.62058], [42.883761, -5.620687], [42.883828, -5.62079],
      [42.883847, -5.620922], [42.883837, -5.621124], [42.883810, -5.621318],
      [42.883827, -5.621519], [42.883874, -5.621639], [42.883896, -5.621736],
      [42.883965, -5.621849], [42.884047, -5.621924], [42.884104, -5.622027],
      [42.884171, -5.622198], [42.884189, -5.622393], [42.884228, -5.622598],
      [42.884248, -5.622733], [42.884277, -5.622893], [42.884291, -5.623021],
      [42.884321, -5.623144], [42.884333, -5.623266], [42.884325, -5.623475],
      [42.88431, -5.6236], [42.88428, -5.623798], [42.884295, -5.623936],
      [42.884284, -5.624071], [42.884259, -5.624271], [42.884216, -5.624468],
      [42.884144, -5.624646], [42.884135, -5.624793], [42.884114, -5.624925],
      [42.884141, -5.625122], [42.884094, -5.625324], [42.884097, -5.625515],
      [42.884095, -5.625641], [42.884087, -5.625835], [42.884092, -5.62604],
      [42.884107, -5.626251], [42.884076, -5.626513], [42.884058, -5.626726],
      [42.884015, -5.626849], [42.883965, -5.62705], [42.883955, -5.627249],
      [42.883952, -5.627459], [42.883951, -5.627675], [42.883936, -5.627811],
      [42.883953, -5.628011], [42.883960, -5.628212], [42.883953, -5.628402],
      [42.883960, -5.628536], [42.883983, -5.628664], [42.884028, -5.62879],
      [42.884056, -5.628991], [42.884058, -5.629191], [42.884070, -5.629323],
      [42.884073, -5.629527], [42.884085, -5.629732], [42.884093, -5.629874],
      [42.884095, -5.630078], [42.884101, -5.630277], [42.884120, -5.630477],
      [42.884162, -5.630607], [42.884197, -5.630727], [42.884221, -5.630859],
      [42.884256, -5.630999], [42.884281, -5.631129], [42.884308, -5.631259],
      [42.884323, -5.631395], [42.884325, -5.63155], [42.884363, -5.631676],
      [42.884355, -5.631886], [42.884324, -5.632076], [42.884289, -5.632204],
      [42.884280, -5.632462], [42.884290, -5.632598], [42.884310, -5.632732],
      [42.884355, -5.632922], [42.884378, -5.633043], [42.884410, -5.633164],
      [42.884412, -5.633296], [42.884434, -5.633449], [42.884446, -5.633642],
      [42.884422, -5.633837], [42.884403, -5.634028], [42.884348, -5.634214],
      [42.884278, -5.634317], [42.884253, -5.634452], [42.884221, -5.634582],
      [42.884187, -5.634715], [42.884142, -5.634834], [42.884085, -5.634951],
      [42.884023, -5.635066], [42.883988, -5.635109], [42.883973, -5.635242],
      [42.883943, -5.635372], [42.883905, -5.635564], [42.883893, -5.635636],
      [42.883878, -5.635768], [42.883774, -5.635756], [42.883682, -5.635723],
      [42.883583, -5.635688], [42.883484, -5.635658], [42.883382, -5.635631]
    ];

    // Crear el mapa centrado en la ruta real
    const map = L.map('mapa-leaflet').setView(centroRuta, 14);
    
    // Capa base: PNOA Máxima Actualidad (ortofoto con datos topográficos)
    L.tileLayer('https://tms-pnoa-ma.idee.es/1.0.0/pnoa-ma/{z}/{x}/{-y}.jpeg', {
      attribution: '© <a href="https://www.ign.es/">IGN</a> - <a href="https://www.scne.es/">PNOA CC-BY 4.0 scne.es</a>',
      maxZoom: 20,
      minZoom: 1,
      tms: true
    }).addTo(map);
    
    // Capa superpuesta: IGN Base Orto (nombres de localidades y etiquetas)
    L.tileLayer('https://tms-ign-base.idee.es/1.0.0/IGNBaseOrto/{z}/{x}/{-y}.png', {
      attribution: '© <a href="https://www.ign.es/">IGN</a> - <a href="https://www.scne.es/">IGN Base CC-BY 4.0 scne.es</a>',
      maxZoom: 19,
      minZoom: 1,
      tms: true,
      opacity: 0.7 // Semi-transparente para que se vea la ortofoto de abajo
    }).addTo(map);
    
    // Icono personalizado para el Faedo
    const iconoFaedo = L.divIcon({
      html: `
        <div style="
          background: #4ade80;
          border: 2px solid #166534;
          border-radius: 50%;
          width: 32px;
          height: 32px;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        ">
          🌳
        </div>
      `,
      className: 'custom-div-icon',
      iconSize: [32, 32],
      iconAnchor: [16, 16],
      popupAnchor: [0, -16]
    });
    
    // Marcador en el punto de inicio (Ciñera de Gordón)
    const marcadorInicio = L.marker([42.883939, -5.636200], { icon: iconoFaedo })
      .addTo(map)
      .bindPopup(`
        <div>
          <h4>🚗 Inicio: Ciñera de Gordón</h4>
          <p>Punto de partida de la ruta circular al Faedo de Ciñera.</p>
          <div class="datos">
            <p><strong>📍 Altitud:</strong> 1.067m</p>
            <p><strong>🥾 Distancia total:</strong> 5,6 km (circular)</p>
            <p><strong>⭐ Dificultad:</strong> Fácil-Moderada</p>
            <p><strong>⏱️ Tiempo:</strong> 2-2,5 horas</p>
            <p><strong>🎯 Desnivel:</strong> +104m</p>
            <p><strong>🍂 Mejor época:</strong> Otoño (colores)</p>
          </div>
        </div>
      `, { maxWidth: 300 });
    
    // Puntos de interés basados en el track real corregido
    const puntosInteres = [
      {
        coords: [42.883634, -5.620341],
        titulo: "🌲 Entrada al bosque",
        descripcion: "Primer contacto con el faedo. Altitud: 1.111m. Aquí empieza el bosque de hayas."
      },
      {
        coords: [42.885881, -5.611035],
        titulo: "🏔️ Punto más alto",
        descripcion: "Máxima altitud de la ruta: 1.170m. Vistas espectaculares del valle."
      },
      {
        coords: [42.886542, -5.609617],
        titulo: "🌳 Corazón del Faedo",
        descripcion: "Centro del bosque de hayas centenario. Las hayas más impresionantes están aquí."
      },
      {
        coords: [42.886278, -5.610398],
        titulo: "👁️ Mirador panorámico",
        descripcion: "Vista hacia los Picos de Europa en días despejados. Altitud: 1.155m."
      },
      {
        coords: [42.883845, -5.620850],
        titulo: "💧 Área de descanso",
        descripcion: "Zona con sombra natural perfecta para una pausa. Altitud: 1.112m."
      }
    ];
    
    // Añadir marcadores de puntos de interés
    puntosInteres.forEach((punto, index) => {
      const iconoPunto = L.divIcon({
        html: `
          <div style="
            background: #3b82f6;
            border: 2px solid #1e40af;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
          ">
            ${index + 1}
          </div>
        `,
        className: 'custom-div-icon',
        iconSize: [24, 24],
        iconAnchor: [12, 12],
        popupAnchor: [0, -12]
      });
      
      L.marker(punto.coords, { icon: iconoPunto })
        .addTo(map)
        .bindPopup(`
          <div>
            <h4>${punto.titulo}</h4>
            <p>${punto.descripcion}</p>
          </div>
        `);
    });
    
    // Dibujar la ruta real del GPX optimizada para vista satélite
    const polylineRuta = L.polyline(rutaCompleta, {
      color: '#ffff00',
      weight: 4,
      opacity: 0.9,
      dashArray: '10, 5',
      lineCap: 'round',
      lineJoin: 'round'
    }).addTo(map);
    
    // Añadir una línea de sombra negra para mejor contraste en satélite
    const sombraRuta = L.polyline(rutaCompleta, {
      color: '#000000',
      weight: 6,
      opacity: 0.7,
      lineCap: 'round',
      lineJoin: 'round'
    }).addTo(map);
    
    // Mover la sombra detrás de la ruta principal
    sombraRuta.bringToBack();
    
    // Ajustar vista para mostrar toda la ruta
    map.fitBounds(polylineRuta.getBounds(), { padding: [20, 20] });
    
    // Añadir leyenda
    const leyenda = L.control({ position: 'bottomright' });
    leyenda.onAdd = function (map) {
      const div = L.DomUtil.create('div', 'info legend');
      div.innerHTML = `
        <div style="
          background: rgba(255,255,255,0.95);
          padding: 12px;
          border-radius: 8px;
          box-shadow: 0 2px 6px rgba(0,0,0,0.3);
          font-size: 12px;
          line-height: 20px;
          border-left: 4px solid #ffff00;
        ">
          <div style="font-weight: bold; margin-bottom: 6px; color: #e67e00;">Ruta del Faedo de Ciñera</div>
          <div><span style="color: #ffff00; font-weight: bold; text-shadow: 1px 1px 1px #000;">━━━</span> Track GPS real (5,6 km)</div>
          <div>🛰️ PNOA + IGN Base superpuestos</div>
          <div>🏷️ Ortofoto con nombres de localidades</div>
          <div>🚗 Inicio en Ciñera de Gordón</div>
          <div>🌳 Bosque de hayas centenario</div>
          <div>⛰️ Desnivel: +104m (1.067-1.170m)</div>
          <div>① ② ③ ④ ⑤ Puntos destacados</div>
        </div>
      `;
      return div;
    };
    leyenda.addTo(map);
    
    // Añadir escala
    L.control.scale({ position: 'bottomleft', metric: true, imperial: false }).addTo(map);
  });
</script>